<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Prompt Terapi - Bebas Nyeri</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { max-width:800px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
h2 { text-align:center; }
input, textarea, select { width:100%; padding:8px; margin:6px 0 12px; border-radius:6px; border:1px solid #ccc; }
button { padding:10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.primary { background:#2e86de; color:white; }
.success { background:#27ae60; color:white; }
textarea { min-height:90px; }
.small { font-size:12px; color:#666; }
</style>
</head>
<body>
<div class="container">
<h2>Form Konsultasi Terapi Bebas Nyeri</h2>

<label>Nama Pasien</label>
<input id="nama">

<label>Umur</label>
<input id="umur" type="number">

<label>Jenis Kelamin</label>
<select id="jk">
<option>Laki-laki</option>
<option>Perempuan</option>
</select>

<label>Sedang Hamil?</label>
<select id="hamil"><option>Tidak</option><option>Ya</option></select>

<label>Jika hamil, berapa bulan?</label>
<input id="bulanHamil">

<label>Pernah Operasi? Operasi apa?</label>
<textarea id="operasi"></textarea>

<label>Keluhan Saat Ini</label>
<textarea id="keluhan"></textarea>

<label>Riwayat Penyakit</label>
<textarea id="penyakit"></textarea>

<label>Hasil Rekam Medis (HB, tensi, dll)</label>
<textarea id="medis"></textarea>

<button class="primary" onclick="buatPrompt()">Buat Prompt AI + Copy</button>

<label>Hasil Saran Terapi</label>
<textarea id="hasilAI"></textarea>

<button class="success" onclick="buatDanSharePDF()">Buat & Share Laporan PDF Pasien</button>

<p class="small">Terapis: Bpk. Abu Khoir, S.Pd., M.Kom</p>
</div>

<script>
function hapusEmoji(teks){
 return teks.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,"").replace(/\s{2,}/g," ");
}

function buatPrompt(){
const prompt = `Anda adalah asisten terapi BebasNyeri.com.

Data Pasien:
Nama: ${nama.value}
Umur: ${umur.value}
Jenis Kelamin: ${jk.value}
Sedang Hamil: ${hamil.value}
Bulan Kehamilan: ${bulanHamil.value}
Riwayat Operasi: ${operasi.value}
Keluhan: ${keluhan.value}
Riwayat Penyakit: ${penyakit.value}
Hasil Rekam Medis: ${medis.value}

Berikan saran terapi & pantangan makan/minum TANPA EMOJI.`;

navigator.clipboard.writeText(prompt);
alert("Prompt berhasil disalin");
}

async function buatDanSharePDF(){
try{
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
const logoUrl = "https://khususprojectku.github.io/terapiislami.com/logo.png";
const tanggal = new Date().toLocaleDateString("id-ID");

// ambil logo
const logoBlob = await fetch(logoUrl).then(r=>r.blob());
const logoBase64 = await new Promise(res=>{
 const fr=new FileReader();
 fr.onload=()=>res(fr.result);
 fr.readAsDataURL(logoBlob);
});

const pageHeight = doc.internal.pageSize.height;
let y=20;

function header(){
 doc.addImage(logoBase64,"PNG",10,8,25,25);
 doc.setFontSize(14);
 doc.text("LAPORAN TERAPI BEBAS NYERI",105,15,null,null,"center");
 doc.setFontSize(10);
 doc.text("Jln. Cendana no. 3 Kisaran",105,22,null,null,"center");
 doc.line(10,35,200,35);
 y=45;
}

function baris(teks,bold=false){
 if(y>pageHeight-20){doc.addPage();header();}
 doc.setFont(undefined,bold?"bold":"normal");
 doc.text(teks,10,y);
 y+=7;
}

function paragraf(judul,isi){
 baris(judul,true);
 doc.splitTextToSize(hapusEmoji(isi),180).forEach(t=>baris(t));
 y+=2; doc.line(10,y,200,y); y+=6;
}

header();
baris("Tanggal: "+tanggal);
baris("Nama: "+hapusEmoji(nama.value));
baris("Umur: "+umur.value+" tahun");
baris("Jenis Kelamin: "+jk.value);
y+=5;

paragraf("STATUS KEHAMILAN",`Sedang Hamil: ${hamil.value}\nBulan: ${bulanHamil.value}`);
paragraf("RIWAYAT OPERASI",operasi.value);
paragraf("KELUHAN",keluhan.value);
paragraf("RIWAYAT PENYAKIT",penyakit.value);
paragraf("HASIL REKAM MEDIS",medis.value);
paragraf("SARAN TERAPI & PANTANGAN",hasilAI.value);

baris("Catatan: Terapi pendamping, bukan pengganti dokter.");
y+=10;
baris("Terapis,"); y+=12;
baris("Bpk. Abu Khoir, S.Pd., M.Kom",true);

// ===== QR CODE STABIL =====
const qrDataUrl = await QRCode.toDataURL("https://www.bebasnyeri.com");
const lastPage = doc.getNumberOfPages();
doc.setPage(lastPage);
doc.addImage(qrDataUrl,"PNG",150,250,40,40);
doc.setFontSize(9);
doc.text("Scan untuk info klinik",150,245);

// nomor halaman
const total=doc.getNumberOfPages();
for(let i=1;i<=total;i++){
 doc.setPage(i);
 doc.setFontSize(10);
 doc.text("Halaman "+i+" dari "+total,105,290,null,null,"center");
}

const blob=doc.output("blob");
const file=new File([blob],"Laporan_Terapi_"+nama.value+".pdf",{type:"application/pdf"});

if(navigator.canShare && navigator.canShare({files:[file]})){
 await navigator.share({files:[file],title:"Laporan Terapi"});
}else{
 doc.save("Laporan_Terapi_"+nama.value+".pdf");
}

}catch(err){
 alert("Gagal membuat PDF: "+err.message);
 console.error(err);
}
}
</script>
</body>
</html>
